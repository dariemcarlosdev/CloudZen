@page "/whoiam"
@using CloudZen.Services
@using CloudZen.Models
@using CloudZen.Shared.Profile
@using CloudZen.Shared.Projects
@inject ResumeService ResumeService
@inject ProjectService ProjectService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<!-- Last significant change: Refactored to use ProfileHeader and ProfileApproach components. Projects loaded from ProjectService. -->
<section id="who-i-am" class="bg-white py-8">
    <div class="max-w-6xl mx-auto px-6 lg:px-8">
        <ProfileHeader 
            AvatarUrl="/images/dariem-avatar.png"
            AltText="Dariem C. Macias - CloudZen"
            Title="Who I Am"
            NameHighlight="Dariem C. Macias here"
            RoleDescription="Software Engineer and Principal Consultant at CloudZen Inc., where I turn complex business challenges into elegant, cloud-first solutions."
            DetailedDescription="Over the past seven years, I've designed and delivered scalable, secure ASP.NET Core applications and enterprise backend systems, leveraging Azure cloud solutions and high-performance ETL pipelines. More recently, I've focused on AI and intelligent automation with Azure OpenAI to improve data workflows, enhance user experiences, and support smarter business decision-making. I excel at modernizing legacy platforms and integrating AI-driven capabilities, building solutions that address real business challenges while empowering teams and stakeholders."
            LinkedInUrl="https://www.linkedin.com/in/dariemcmacias"
            GitHubUrl="https://github.com/dariemcarlosdev?tab=repositories" />
        
        <!-- SDLC Process Panel: Interactive, Responsive, and Highlights Each Stage -->
        <SDLCProcess></SDLCProcess>
        
        <div class="grid md:grid-cols-2 gap-12 items-start mt-8">
            <!-- Left Column: Bio -->
            <ProfileApproach />

            <!-- Right Column: Results Highlights -->
            <ProfileHighlights OnResumeDownload="DownloadResume" />
        </div>

        <!-- Projects Section -->
        <div class="mt-20">
            <h3 id="highlighted-projects" class="text-2xl font-semibold text-gray-700 mb-8 text-center">Highlighted Projects</h3>
            <p class="text-gray-600 text-center mt-2 mb-8">This project showcases how I bring together software engineering, cloud - native design, and applied AI to solve a concrete business problem while also reflecting my ability to start from scratch, iterate quickly, and deliver production-ready systems.</p>
            
            <!-- Project Filter Component -->
            <ProjectFilter OnFilterChange="HandleFilterChange" />
            
            <!-- Projects List -->
            @if (FilteredProjects.Any())
            {
                <div class="flex flex-col gap-8">
                    @foreach (var project in FilteredProjects)
                    {
                        <ProjectCard Project="@project" />
                    }
                </div>
            }
            else
            {
                <div class="text-center py-12">
                    <i class="bi bi-inbox text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">No projects match the selected filters.</p>
                    <p class="text-gray-400 text-sm mt-2">Try adjusting or clearing your filters.</p>
                </div>
            }
        </div>
    </div>
</section>

@code {

    // Attributes to hold all projects and filtered projects
    private List<ProjectInfo> Projects = new();
    private List<ProjectInfo> FilteredProjects = new();

    protected override void OnInitialized()
    {
        // Load projects from ProjectService
        Projects = ProjectService.GetAllProjects();
        // Initially show all projects, FilteredProjects is same as Projects for no filters applied.
        FilteredProjects = Projects;
    }

    /// <summary>
    /// Handles filter changes from the ProjectFilter component.
    /// Filters projects based on selected status and project type.
    /// This method is passed as a callback to the ProjectFilter component.
    /// </summary>
/// <param name="filters">Tuple containing status and project type filter values.</param>
private void HandleFilterChange((string Status, string ProjectType) filters)
{
        // Apply filtering logic
    FilteredProjects = Projects
        .Where(p => string.IsNullOrEmpty(filters.Status) || p.Status == filters.Status)
        .Where(p => string.IsNullOrEmpty(filters.ProjectType) || 
                    (filters.ProjectType == "Customer" 
                        ? p.ProjectType.StartsWith("Customer:") 
                        : p.ProjectType == filters.ProjectType))
        .ToList();
}

    /// <summary>
    /// Method to download the resume using ResumeService and JS interop.
    /// </summary>
    /// <returns></returns>
    private async Task DownloadResume()
    {
        var resumeBytes = await ResumeService.DownloadResumeAsync();
        var uri = new Uri(ResumeService.ResumeBlobUrl);
        var fileName = System.IO.Path.GetFileName(uri.LocalPath);
        await JS.InvokeVoidAsync("saveAsFile", fileName, resumeBytes);
    }

    // Last significant change: OnAfterRenderAsync checks for scroll query parameter and uses JS interop to scroll to Highlighted Projects from CaseStudies.razor.
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var scrollTarget = query["scroll"];
            if (scrollTarget == "highlighted-projects")
            {
                await JS.InvokeVoidAsync("scrollToElementById", "highlighted-projects");
            }
        }
    }
}

